<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply Database Migration 007</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .step {
      background: #f8f9fa;
      border-left: 4px solid #0070f3;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .step h3 {
      margin-top: 0;
      color: #0070f3;
    }
    code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    textarea {
      width: 100%;
      height: 300px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0051cc;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #155724;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #856404;
    }
    .info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #0c5460;
    }
    ul {
      line-height: 1.8;
    }
    .btn-group {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Apply Database Migration 007</h1>
    <p><strong>Migration:</strong> customer_google_ads_accounts table</p>
    <p><strong>Date:</strong> December 27, 2025</p>

    <div class="info">
      <strong>üìã What this migration does:</strong>
      <ul>
        <li>Creates <code>customer_google_ads_accounts</code> table for storing Google Ads OAuth tokens</li>
        <li>Adds 3 performance indexes</li>
        <li>Sets up 5 RLS policies for customer data isolation</li>
        <li>Creates <code>updated_at</code> trigger</li>
      </ul>
    </div>

    <div class="step">
      <h3>Step 1: Copy Migration SQL</h3>
      <p>Click the button below to copy the migration SQL to your clipboard:</p>
      <textarea id="migrationSQL" readonly></textarea>
      <div class="btn-group">
        <button onclick="copyToClipboard()">üìã Copy SQL to Clipboard</button>
        <button class="secondary" onclick="downloadSQL()">üíæ Download SQL File</button>
      </div>
    </div>

    <div class="step">
      <h3>Step 2: Open Supabase Dashboard</h3>
      <p>Go to your Supabase project's SQL Editor:</p>
      <ol>
        <li>Open <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
        <li>Select your project</li>
        <li>Click <strong>"SQL Editor"</strong> in the left sidebar</li>
        <li>Click <strong>"+ New query"</strong> button</li>
      </ol>
    </div>

    <div class="step">
      <h3>Step 3: Paste and Execute</h3>
      <ol>
        <li>Paste the copied SQL into the SQL Editor</li>
        <li>Click the <strong>"Run"</strong> button (or press Ctrl+Enter)</li>
        <li>Wait for the success message</li>
      </ol>
    </div>

    <div class="warning">
      <strong>‚ö†Ô∏è If you see "already exists" errors:</strong>
      <p>This is normal and safe - it means the table or index was already created in a previous attempt. You can ignore these errors.</p>
    </div>

    <div class="success" id="successMessage" style="display: none;">
      <strong>‚úÖ Migration Applied Successfully!</strong>
      <p>You can now use the Google Ads reporting features in your customer portal.</p>
      <p><strong>Next steps:</strong></p>
      <ul>
        <li>Configure Google OAuth credentials in environment variables</li>
        <li>Test the connection flow at <code>/app/reports</code></li>
        <li>Verify customers can connect their Google Ads accounts</li>
      </ul>
    </div>

    <div class="btn-group">
      <button onclick="markAsComplete()">‚úÖ Mark as Complete</button>
      <button class="secondary" onclick="window.close()">Close</button>
    </div>
  </div>

  <script>
    // Load migration SQL from file
    const migrationSQL = `-- Migration 007: Customer Google Ads Accounts
-- Purpose: Store customer-specific Google Ads OAuth tokens for read-only reporting access
-- Date: December 27, 2025

-- 1. Create customer_google_ads_accounts table
CREATE TABLE IF NOT EXISTS customer_google_ads_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Google Ads Account Info
  google_ads_customer_id TEXT NOT NULL,
  
  -- OAuth Tokens
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  scope TEXT,
  
  -- Account Metadata
  account_name TEXT,
  currency_code TEXT,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'disconnected')),
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Constraints
  UNIQUE(customer_id) -- One Google Ads account per customer
);

-- 2. Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_customer_google_ads_customer_id 
  ON customer_google_ads_accounts(customer_id);

CREATE INDEX IF NOT EXISTS idx_customer_google_ads_expires_at 
  ON customer_google_ads_accounts(expires_at) 
  WHERE status = 'active';

CREATE INDEX IF NOT EXISTS idx_customer_google_ads_status 
  ON customer_google_ads_accounts(status);

-- 3. Row Level Security (RLS) policies
ALTER TABLE customer_google_ads_accounts ENABLE ROW LEVEL SECURITY;

-- Customers can only access their own Google Ads connections
CREATE POLICY "Customers can view their own Google Ads account"
  ON customer_google_ads_accounts
  FOR SELECT
  TO authenticated
  USING (customer_id = auth.uid());

CREATE POLICY "Customers can insert their own Google Ads account"
  ON customer_google_ads_accounts
  FOR INSERT
  TO authenticated
  WITH CHECK (customer_id = auth.uid());

CREATE POLICY "Customers can update their own Google Ads account"
  ON customer_google_ads_accounts
  FOR UPDATE
  TO authenticated
  USING (customer_id = auth.uid())
  WITH CHECK (customer_id = auth.uid());

CREATE POLICY "Customers can delete their own Google Ads account"
  ON customer_google_ads_accounts
  FOR DELETE
  TO authenticated
  USING (customer_id = auth.uid());

-- Service role has full access (for admin operations)
CREATE POLICY "Service role has full access to customer_google_ads_accounts"
  ON customer_google_ads_accounts
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- 4. Updated_at trigger
CREATE OR REPLACE FUNCTION update_customer_google_ads_accounts_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER customer_google_ads_accounts_updated_at
  BEFORE UPDATE ON customer_google_ads_accounts
  FOR EACH ROW
  EXECUTE FUNCTION update_customer_google_ads_accounts_updated_at();

-- 5. Comments for documentation
COMMENT ON TABLE customer_google_ads_accounts IS 'Customer-specific Google Ads OAuth tokens for read-only reporting access';
COMMENT ON COLUMN customer_google_ads_accounts.customer_id IS 'Reference to auth.users - customer who owns this connection';
COMMENT ON COLUMN customer_google_ads_accounts.google_ads_customer_id IS 'Google Ads Customer ID (format: 123-456-7890)';
COMMENT ON COLUMN customer_google_ads_accounts.access_token IS 'OAuth access token (short-lived, auto-refreshed)';
COMMENT ON COLUMN customer_google_ads_accounts.refresh_token IS 'OAuth refresh token (long-lived, used to get new access tokens)';
COMMENT ON COLUMN customer_google_ads_accounts.expires_at IS 'Access token expiration timestamp';
COMMENT ON COLUMN customer_google_ads_accounts.status IS 'Connection status: active, inactive, disconnected';`;

    document.getElementById('migrationSQL').value = migrationSQL;

    function copyToClipboard() {
      const textarea = document.getElementById('migrationSQL');
      textarea.select();
      document.execCommand('copy');
      
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Copied!';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }

    function downloadSQL() {
      const blob = new Blob([migrationSQL], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '007_customer_google_ads.sql';
      a.click();
    }

    function markAsComplete() {
      document.getElementById('successMessage').style.display = 'block';
      window.scrollTo(0, document.body.scrollHeight);
    }
  </script>
</body>
</html>
