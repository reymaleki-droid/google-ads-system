#!/usr/bin/env nodeimport { createClient } from '@supabase/supabase-js';import { readFileSync } from 'fs';function parseEnvFile(filePath) {  const content = readFileSync(filePath, 'utf8');  const env = {};    for (const line of content.split('\n')) {    const trimmed = line.trim();    if (!trimmed || trimmed.startsWith('#')) continue;        const match = trimmed.match(/^([^=]+)=(.*)$/);    if (match) {      const key = match[1].trim();      let value = match[2].trim();      value = value.replace(/^["']|["']$/g, '');      value = value.replace(/\\r\\n|\\n|\\r/g, '');      value = value.trim();      env[key] = value;    }  }  return env;}const env = parseEnvFile('.env.production');const supabaseUrl = env.NEXT_PUBLIC_SUPABASE_URL;const anonKey = env.NEXT_PUBLIC_SUPABASE_ANON_KEY;const serviceKey = env.SUPABASE_SERVICE_ROLE_KEY;if (!supabaseUrl || !anonKey || !serviceKey) {  console.error('‚ùå Missing environment variables');  process.exit(1);}const anonClient = createClient(supabaseUrl, anonKey);const serviceClient = createClient(supabaseUrl, serviceKey);let failures = 0;async function test(name, fn) {  try {    const result = await fn();    if (result) {      console.log(`‚úÖ PASS: ${name}`);    } else {      console.log(`‚ùå FAIL: ${name}`);      failures++;    }  } catch (error) {    console.log(`‚ùå FAIL: ${name} - ${error.message}`);    failures++;  }}async function main() {  console.log('\nüîí RLS VERIFICATION\n');  console.log('NOTE: Table GRANT for SELECT exists (PostgREST requirement).');  console.log('Security enforced by RLS policies with USING (false).\n');  // Test 1: anon INSERT (should work)  await test('anon INSERT lead', async () => {    const { error } = await anonClient      .from('leads')      .insert({        full_name: 'RLS Test',        email: `rls-test-${Date.now()}@test.local`,        phone: '+971501234567',        goal_primary: 'Test',        monthly_budget_range: '1000-1999',        timeline: 'ASAP',        lead_score: 50,        lead_grade: 'B',        recommended_package: 'growth',        consent: true      });    return !error;  });  // Test 2: anon SELECT blocked  await test('anon SELECT blocked (leads)', async () => {    const { data, error } = await anonClient      .from('leads')      .select('*')      .limit(1);        const blocked = (error && (error.code === '42501' || error.message.includes('row-level security')))                     || (!error && (!data || data.length === 0));        if (blocked && !error) {      console.log('      (SELECT GRANT exists, but RLS denies access. This is expected.)');    }    return blocked;  });  // Test 3: anon UPDATE blocked  await test('anon UPDATE blocked (leads)', async () => {    const { data, error } = await anonClient      .from('leads')      .update({ status: 'contacted' })      .eq('full_name', 'RLS Test');        const blocked = (error && (error.code === '42501' || error.message.includes('row-level security')))                    || (!error && (!data || data.length === 0));    return blocked;  });  // Test 4: anon DELETE blocked  await test('anon DELETE blocked (leads)', async () => {    const { data, error } = await anonClient      .from('leads')      .delete()      .eq('full_name', 'RLS Test');        const blocked = (error && (error.code === '42501' || error.message.includes('row-level security')))                    || (!error && (!data || data.length === 0));    return blocked;  });  // Test 5: anon INSERT booking (should work)  await test('anon INSERT booking', async () => {    // Create lead with service_role    const { data: lead, error: leadError } = await serviceClient      .from('leads')      .insert({        full_name: 'Booking Test',        email: `booking-test-${Date.now()}@test.local`,        phone: '+971501234567',        goal_primary: 'Test',        monthly_budget_range: '1000-1999',        timeline: 'ASAP',        lead_score: 50,        lead_grade: 'B',        recommended_package: 'growth',        consent: true      })      .select('id')      .single();        if (leadError || !lead) return false;        const { error } = await anonClient      .from('bookings')      .insert({        lead_id: lead.id,        booking_start_utc: new Date().toISOString(),        booking_end_utc: new Date(Date.now() + 3600000).toISOString(),        booking_timezone: 'Asia/Dubai'      });        return !error;  });  // Test 6: anon SELECT blocked (bookings)  await test('anon SELECT blocked (bookings)', async () => {    const { data, error } = await anonClient      .from('bookings')      .select('*')      .limit(1);        const blocked = (error && (error.code === '42501' || error.message.includes('row-level security')))                    || (!error && (!data || data.length === 0));        if (blocked && !error) {      console.log('      (SELECT GRANT exists, but RLS denies access. This is expected.)');    }    return blocked;  });  // Test 7: anon google_tokens blocked  await test('anon access google_tokens blocked', async () => {    const { data, error } = await anonClient      .from('google_tokens')      .select('*')      .limit(1);        const blocked = (error && (error.code === '42501' || error.message.includes('row-level security') || error.message.includes('does not exist')))                    || (!error && (!data || data.length === 0));    return blocked;  });  // Test 8: service_role full access  await test('service_role full access', async () => {    const { error } = await serviceClient      .from('leads')      .select('*')      .limit(1);    return !error;  });  console.log('\n' + '='.repeat(60));  if (failures === 0) {    console.log('‚úÖ ALL 8 TESTS PASSED\n');    process.exit(0);  } else {    console.log(`‚ùå ${failures} TESTS FAILED\n`);    process.exit(1);  }}main();